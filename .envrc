#!/usr/bin/env bash

if ! has uv; then
	echo "uv is not installed"
	exit 1
fi

watch_file pyproject.toml
watch_file uv.lock

if [ ! -d .venv ]; then
	uv venv
fi

# Detect platform and GPU availability for FAISS backend selection
PLATFORM="$(uname -s)"
PYTHON_MINOR=$(python3 -c 'import sys; print(sys.version_info.minor)')
FAISS_EXTRA="cpu"

if [ "$PLATFORM" = "Linux" ]; then
	# faiss-gpu only supports Python <3.13 (i.e., minor version < 13)
	if command -v nvidia-smi &> /dev/null && [ "$PYTHON_MINOR" -lt 13 ]; then
		echo "Detected Linux with NVIDIA GPU and Python 3.$PYTHON_MINOR - using faiss-gpu"
		FAISS_EXTRA="gpu"
	elif command -v nvidia-smi &> /dev/null; then
		echo "Detected Linux with NVIDIA GPU but Python 3.$PYTHON_MINOR >= 3.13 - faiss-gpu not available, using faiss-cpu"
	fi
fi

# Sync with the appropriate FAISS backend (cpu or gpu)
uv sync --all-groups --extra "$FAISS_EXTRA"

source .venv/bin/activate
