---
services:
  prometheus:
    image: prom/prometheus:latest
    restart: on-failure:3
    user: 0:0  # Run as root for Podman compatibility
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --web.enable-lifecycle
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus:z
    ports: [9090:9090]
    extra_hosts: [host.docker.internal:host-gateway]
    networks: [monitoring]
    healthcheck:
      test: [CMD, wget, --spider, -q, http://localhost:9090/-/healthy]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  grafana:
    image: grafana/grafana:latest
    restart: on-failure:3
    user: 0:0  # Run as root for Podman compatibility
    ports: [3000:3000]
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD:-admin}
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
      - GF_PATHS_DATA=/var/lib/grafana
    volumes:
      - grafana-storage:/var/lib/grafana:z
      - ./grafana/provisioning:/etc/grafana/provisioning:ro,z
    networks: [monitoring]
    depends_on:
      prometheus:
        condition: service_healthy
      loki:
        condition: service_healthy
      tempo:
        condition: service_healthy
    healthcheck:
      test: [CMD, wget, --spider, -q, http://localhost:3000/api/health]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  loki:
    image: grafana/loki:2.9.8
    restart: on-failure:3
    command: [-config.file=/etc/loki/local-config.yaml]
    user: 0:0  # Run as root for Podman compatibility
    volumes:
      - ./loki/config.yaml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki:z
    ports: [3100:3100]
    networks: [monitoring]
    healthcheck:
      test: [CMD, wget, --spider, -q, http://localhost:3100/ready]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  promtail:
    image: grafana/promtail:2.9.8
    restart: on-failure:3
    user: 0:0  # Run as root for Podman compatibility
    command: [-config.file=/etc/promtail/config.yml]
    volumes:
      - ./promtail/promtail.yaml:/etc/promtail/config.yml:ro,z
      - ../logs:/var/log/pipeline:ro,z
      - promtail-positions:/tmp:z
    networks: [monitoring]
    depends_on:
      loki:
        condition: service_healthy
    healthcheck:
      test: [CMD, wget, --spider, -q, http://localhost:9080/ready]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.1'

  tempo:
    image: grafana/tempo:2.6.0
    restart: on-failure:3
    user: 0:0  # Run as root for Podman compatibility
    command: [-config.file=/etc/tempo/tempo.yaml]
    volumes:
      - ./tempo/tempo.yaml:/etc/tempo/tempo.yaml:ro,z
      - tempo-data:/var/tempo:z
    ports:
      - 3200:3200
      # Note: OTLP ports 4317/4318 are exposed via otel-collector instead
    networks: [monitoring]
    healthcheck:
      test: [CMD, wget, --spider, -q, http://localhost:3200/ready]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.98.0
    restart: on-failure:3
    user: 0:0  # Run as root for Podman compatibility
    command: [--config=/etc/otelcol/config.yaml]
    volumes: ['./otel-collector/config.yaml:/etc/otelcol/config.yaml:ro,z']
    ports:
      - 4317:4317  # OTLP gRPC (external access)
      - 4318:4318  # OTLP HTTP (external access)
      - 8888:8888  # Collector metrics
      - 8889:8889  # Prometheus exporter
    networks: [monitoring]
    depends_on:
      tempo:
        condition: service_healthy
    extra_hosts: [host.docker.internal:host-gateway]
    healthcheck:
      test: [CMD, wget, --spider, -q, http://localhost:13133/]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

networks:
  monitoring:
    name: monitoring-network
    driver: bridge

volumes:
  grafana-storage:
    name: grafana-storage
  tempo-data:
    name: tempo-data
  prometheus-data:
    name: prometheus-data
  loki-data:
    name: loki-data
  promtail-positions:
    name: promtail-positions
